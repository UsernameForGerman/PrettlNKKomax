<!doctype html>
<html>

{% load i18n %}
{% load static %}

{% block title %}
    <title>{% trans 'Komax app' %}</title>
{% endblock %}

{% block head %}

     <script src="js/jquery-3.1.1.min.js"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
              rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
              crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="{% static 'komax_app/maketasks.css' %}" >
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
  <link href="path/to/css/mmenu.css" rel="stylesheet" />
        <script src="path/to/js/mmenu.js"></script>

        <!-- Fire the plugin -->
        <script>
            document.addEventListener(
                "DOMContentLoaded", () => {
                    new Mmenu( "#my-menu", {
                       "extensions": [
                          "pagedim-black"
                       ]
                    });
                }
            );
        </script>
        <style>
             body
            {

                    padding-top: 150px;
                background-size:100%;
                background-color: #868884;
                background: -moz-linear-gradient(-45deg, #868884 0%, #E8F1FF 50%, #868884 100%);
                 background: -webkit-linear-gradient(-45deg, #868884 0%, #E8F1FF 50%, #868884 100%);
                background: linear-gradient(135deg, #868884 0%, #E8F1FF 50%, #868884 100%);
                background-attachment: fixed;
            }
        </style>
        <style>
            header
            {

            position: fixed;
            width: 100  vw;
            top: 0;
            background-color: white;
            box-shadow: 0px 5px 4px grey;
            }
        </style>
            <style>
            .btn-dark{

            background-color: #868884;

            color: white;

            }
        </style>

<style>
     .btn-dark:hover{
    background-color: #a2a39f;
}
</style>

<style>
    .btn-dark:focus
    {
      background-color: #868884;
   outline: none;
  color: white;
    }
</style>


         <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
                integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script>window.jQuery || document.write('<script src="https://getbootstrap.com/docs/4.0/assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
      <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/jumbotron/">

    {% endblock %}

    {% block body %}
    <header class="blog-header  fixed-top" >


<div id="root">

</div>

<script src="/static/komax_app/main.js">
</script>
    </header>

    <div class="container" id="komax_app_setup">
        <div class="row">
     <div class="col-sm-6">
        <div class="card-columns" style="column-count: 1">
            <div class="card bg-white" style="width: 100%;">
                <div class="card-body">
                    <h5 class="card-tittle" style="text-align: center"><strong> Set up task</strong></h5>
                    <div class="container">

                        <form method="post" name="form" id="form">
                         {% csrf_token %}
                        <div class="form-row align-items-center">
                            <h5>
                                <label for="task_name" class="col-form-label col-sm-12">Job number:</label>
                            </h5>
                                <div class="col-sm-8" id="task-name-handler">
                                    <input  class="form-control" required type="text" name="task_name" id="task_name" onkeyup="checkParams()">
                                </div>

                            </div><!-- Job number line -->
                               <div class="form-row align-items-center">
                                   <h5>
                                <label class="col-form-label col-lg-12" for="harnesses">Harnesses:&nbsp&nbsp&nbsp</label>
                                   </h5>
                                <div class="col-lg-8 ">

                                    <select class="selectpicker form-control dropright"   name="harnesses" id="harnesses"
                                            onchange="checkParams()"
                                            multiple data-live-search="true" required>
                                        {% for harness in harnesses %}
                                        <option>{{ harness }}</option>
                                        {% endfor %}
                                    </select>

                                </div>
                            </div> <!-- Harnesses line -->
                     <div class="form-row align-items-center">
                         <h5>
                                <label class="col-form-label col-sm-12" for="komaxes">Komaxes:&nbsp&nbsp&nbsp&nbsp&nbsp</label>
                         </h5>
                                <div class="col-sm-8">
                                    <select class="selectpicker form-control dropright" name="komaxes" id="komaxes"
                                            onchange="checkParams()"
                                            multiple data-live-search="true" required tabindex="-98">

                                   {% for komax in komaxes %}
                                        <option>{{ komax }}</option>
                                        {% endfor %}

                                    </select>
                                </div>
                            </div> <!-- Harnesses line -->
                            <div class="form-row align-items-center">
                                <h5>
                                <label class="col-form-label col-sm-12" for="kappas">Kappas:&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</label>
                                    </h5>
                                <div class="col-sm-8">
                                    <select class="selectpicker form-control dropright" name="kappas" id="kappas"
                                            onchange="checkParams()"
                                            multiple data-live-search="true" required tabindex="-98">
                                        {% for kappa in kappas %}
                                        <option>{{ kappa }}</option>
                                        {% endfor %}

                                    </select>
                                </div>
                            </div><!--kOMAX line-->

                                    <div class="form-row align-items-center">
                                        <h5>
                                        <label class="col-form-label col-sm-12" for="shift">Work shift:&nbsp&nbsp&nbsp</label>
                                            </h5>
                                        <div class="col-sm-8">
                                            <input class="form-control" type="text" name="shift" id="shift"  pattern="\b([1-9]\b)|([1]\d\b)|([2][0-4]\b)" onkeyup="checkParams()" required>
                                        </div>
                                    </div>
                            <div class="container">
                                <div class="row">
                                    <div class="col-lg-12" align="center">
                                        <div class="form-group">
                                            <div class="form-check form-check-inline" align="center">
                                                <input class="form-check-input" type="radio" name="type_of_allocation" id="type_parallel" value="parallel" checked>
                                                <label class="form-check-label" type="type_paralel">
                                                    Parallel
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="type_of_allocation" id="type_consistently" value="consistently" align="center">
                                                <label class="form-check-label" >
                                                    Consistently
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-12" align="center">
                                        <div class="form-group" align="self-center">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="loading_type" id="type_new" value="New" checked>
                                                <label class="form-check-label" type="type_new" >
                                                    New
                                                </label>
                                            </div>

                                            <div class="form-check form-check-inline" align="self-center">
                                                <input class="form-check-input" type="radio" name="loading_type" id="type_mix" value="Mix">
                                                <label class="form-check-label" for="type_mix">
                                                    Mix
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline" align="self-center">
                                                <input class="form-check-input" type="radio" name="loading_type" id="type_urgent"
                                                       value="Urgent">
                                                <label class="form-check-label" for="type_urgent">
                                                    Urgent
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <button id="js-button" type="submit" class="submit btn btn-primary btn-block" disabled>Continue</button>
                                <script>
                                    function checkParams() {
                                        var task_name = $('#task_name').val();
                                        var harnesses = form.harnesses;
                                        var komaxes = form.komaxes;
                                        var kappas = form.kappas;
                                        var shift =$('#shift').val();

                                        var element1 = document.getElementById("harnesses");
                                        var element2 = document.getElementById("komaxes");
                                        var element3 = document.getElementById("kappas");

                                        selectedOption1 = element1.options[element1.selectedIndex];
                                        selectedOption2 = element2.options[element2.selectedIndex];
                                        selectedOption3 = element3.options[element3.selectedIndex];
                                        if( task_name.length != 0 && shift.length !=0 && selectedOption1.length != 0
                                         && selectedOption2.length != 0 && selectedOption3.length != 0 && shift.length !=0)
                                        {
                                            $('#js-button').removeAttr('disabled');

                                        }
                                        else
                                        {
                                            $('#js-button').attr('disabled', 'disabled');
                                        }



                                    }
                                </script>

                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="col-sm-6">
    <div class="container">
        <div class="card-columns" style="column-count: 1">
            <div class="card bg-white" style="width: 103%; ">
                <div class="card-body">
                    <div class="container">
                        <form id="harness-amount-form" method="post">
                             {% csrf_token %}


                        </form>
                                <!-- TYT -->

                            </div>
                        </div> <!-- Harnesses line -->
                    </div>
                </div>

    </div>
        </div>
    </div>
    </div>
    <script>

    var loc = window.location;
    var wsStart = 'wss://';
    if (loc.host.includes('localhost')){
        wsStart = 'ws://'
    }
    var endPoint = wsStart + loc.host + loc.pathname;
    var socket = new WebSocket(endPoint);


    var form = $('#form');
    var komax_app_setup = $('#komax_app_setup');
    var task_name = $('#task_name');
    var harnesses = $('#harnesses');
    var komaxes = $('#komaxes');
    var kappas = $('#kappas');
    var shift = $('#shift');
    var url = '';
    var harness_amount_form;
    var next_step = false;
    var amount_button = false;
    var loading_types = document.getElementsByName('loading_type');
    var loading_type;

    var types_of_allocation = document.getElementsByName('type_of_allocation');
    var type_of_allocation;


    socket.onopen = function (e) {
        // console.log(e);

        $('#task_name').change(function(event){
            var task_name_current = task_name.val();

            if (task_name_current.length > 0){
                var final_data = {
                'info_type': 'checker_info',
                'task_name': task_name_current,
                };
                socket.send(JSON.stringify(final_data))
            }
            else {
                task_name.removeClass('is-valid');
                task_name.removeClass('is-invalid');
                $('.invalid-feedback').remove()
            }


        });
        form.submit(function(event) {
            event.preventDefault();
            $(this).find("button[type='submit']").prop('disabled',true);


            for(var i = 0; i < types_of_allocation.length; i++){
                if(types_of_allocation[i].checked){
                    type_of_allocation = types_of_allocation[i].value;
                }
            }

            for(var j = 0; j < loading_types.length; j++){
                if (loading_types[j].checked){
                    loading_type = loading_types[j].value;
                }
            }

            var final_data = {
                'info_type': 'task_info',
                'task_name': task_name.val(),
                'harnesses': harnesses.val(),
                'komaxes': komaxes.val(),
                'kappas': kappas.val(),
                'shift': shift.val(),
                'type_of_allocation': type_of_allocation,
                'loading_type': loading_type,
            };

            socket.send(JSON.stringify(final_data));



            harness_amount_form = $('#harness-amount-form');

            for (let i = 0; i < harnesses.val().length; i++){
                harness_amount_form.append(
                '<div class="form-group row">' +
                '<label for="harness_amount_' + i + '" class="col-sm-2 col-form-label">' + harnesses.val()[i] + '</label>' +
                '<div class="col-sm-10">' +
                '<input type="number" class="form-control" id="harness_amount_' + i + '" placeholder={% trans "Amount" %} required>' +
                '</div>' +
                '</div>'
                )
            }


        harness_amount_form.submit( function(ev) {
            // console.log("Sumbitted second form");
            ev.preventDefault();
            console.log('harness amount form');
            var amount_info_dict = {
                'info_type': 'amount_info',
            };

            var harness_amount_dict = {};
            for (let i = 0; i < harnesses.val().length; i++){

                var harness_amount = $('#harness_amount_'+ i).val();
                var harness_str = harnesses.val()[i].toString();

                harness_amount_dict[harness_str] = harness_amount;

            }
            amount_info_dict['task_name'] = task_name.val();
            amount_info_dict['harness_amount'] = harness_amount_dict;
            socket.send(JSON.stringify(amount_info_dict));
        });
        })

    };
    socket.onmessage = function (e) {
        // console.log(e)

        message = JSON.parse(e.data);
        var task_name_handler;

        if (message.info_type == 'checker_info') {
            if (message.checker == 0) {
                task_name.removeClass('is-valid');
                task_name.addClass("is-invalid");
                $('.invalid-feedback').remove();
                task_name_handler = $('#task-name-handler');
                task_name_handler.append(
                    '<div class="invalid-feedback">' +
                    '{% blocktrans %} Task with this name already exists or its incorrect{% endblocktrans %}' +
                    '</div>'
                )
            }
            else {
                task_name.removeClass("is-invalid");
                task_name.addClass("is-valid");
                var feedback_invalid = $('.invalid-feedback');
                feedback_invalid.remove();
            }
        }

        if (message.info_type == 'page_status'){
            if (message.status == 'http_redirect') {
                if ('error' in message) {
                    alert("{% blocktrans %}Check marking in harness chart or not enough komaxes{% endblocktrans %}");
                }
                if (message.url != '') {
                    url = message.url;
                    window.location.replace(url)
                    // socket.close()
                }
            }
        }

        if (message.info_type == 'task_status' && message.status == 'loaded') {
            harness_amount_form = $('#harness-amount-form');
            harness_amount_form.append(
                    '<button id="amount_button" type="submit" class="btn btn-primary btn-lg btn-success btn-block" >Push</button>'
                );
        }

    };
    socket.onerror = function (e) {
        // console.log(e)
    };
    socket.onclose = function (e) {
        // console.log(e)
    };


</script>


      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

        <script src="https://getbootstrap.com/docs/4.0/assets/js/vendor/popper.min.js"></script>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>

    {% endblock %}
</html>
